{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "ASAApiVersion": {
      "type": "string"
    },
    "StreamAnalyticsJobName": {
      "type": "string",
      "minLength": 3,
      "maxLength": 63,
      "metadata": {
        "description": "Stream Analytics Job Name, can contain alphanumeric characters and hypen and must be 3-63 characters long"
      }
    },
    "Location": {
      "type": "string"
    },
    "OutputStartMode": {
      "type": "string",
      "allowedValues": [
        "JobStartTime",
        "CustomTime",
        "LastOutputEventTime"
      ]
    },
    "OutputStartTime": {
      "type": "string"
    },
    "DataLocale": {
      "type": "string"
    },
    "OutputErrorPolicy": {
      "type": "string",
      "allowedValues": [
        "Drop",
        "Stop"
      ]
    },
    "EventsLateArrivalMaxDelayInSeconds": {
      "type": "int"
    },
    "EventsOutOfOrderMaxDelayInSeconds": {
      "type": "int"
    },
    "EventsOutOfOrderPolicy": {
      "type": "string",
      "allowedValues": [
        "Adjust",
        "Drop"
      ]
    },
    "StreamingUnits": {
      "type": "int",
      "minValue": 1,
      "maxValue": 192,
      "metadata": {
        "description": "Number of Streaming Units"
      },
      "allowedValues": [
        1,
        3,
        6,
        12,
        18,
        24,
        30,
        36,
        42,
        48,
        54,
        60,
        66,
        72,
        78,
        84,
        90,
        96,
        102,
        108,
        114,
        120,
        126,
        132,
        138,
        144,
        150,
        156,
        162,
        168,
        174,
        180,
        186,
        192
      ]
    },
    "CompatibilityLevel": {
      "type": "string",
      "allowedValues": [
        "1.0",
        "1.1",
        "1.2"
      ]
    },
    "Input_iothub_iotHubNamespace": {
      "type": "string"
    },
    "Input_iothub_consumerGroupName": {
      "type": "string"
    },
    "Input_iothub_endpoint": {
      "type": "string"
    },
    "Input_iothub_sharedAccessPolicyName": {
      "type": "string"
    },
    "Input_iothub_sharedAccessPolicyKey": {
      "type": "string"
    },
    "Output_cosmosdb_accountId": {
      "type": "string"
    },
    "Output_cosmosdb_accountKey": {
      "type": "string"
    },
    "Output_cosmosdb_database": {
      "type": "string"
    },
    "Output_cosmosdb_collectionNamePattern": {
      "type": "string"
    },
    "Output_cosmosdb_documentId": {
      "type": "string"
    },
    "Output_NotificationsEventHub_serviceBusNamespace": {
      "type": "string"
    },
    "Output_NotificationsEventHub_eventHubName": {
      "type": "string"
    },
    "Output_NotificationsEventHub_partitionKey": {
      "type": "string"
    },
    "Output_NotificationsEventHub_sharedAccessPolicyName": {
      "type": "string"
    },
    "Output_NotificationsEventHub_sharedAccessPolicyKey": {
      "type": "string"
    }
  },
  "resources": [
    {
      "type": "Microsoft.StreamAnalytics/StreamingJobs",
      "apiVersion": "[parameters('ASAApiVersion')]",
      "name": "[parameters('StreamAnalyticsJobName')]",
      "location": "[parameters('Location')]",
      "properties": {
        "outputStartMode": "[parameters('OutputStartMode')]",
        "outputStartTime": "[if(equals(parameters('OutputStartMode'),'CustomTime'), parameters('OutputStartTime'), json('null'))]",
        "sku": {
          "name": "standard"
        },
        "jobType": "Cloud",
        "eventsOutOfOrderPolicy": "[parameters('EventsOutOfOrderPolicy')]",
        "outputErrorPolicy": "[parameters('OutputErrorPolicy')]",
        "eventsOutOfOrderMaxDelayInSeconds": "[parameters('EventsOutOfOrderMaxDelayInSeconds')]",
        "eventsLateArrivalMaxDelayInSeconds": "[parameters('EventsLateArrivalMaxDelayInSeconds')]",
        "dataLocale": "[parameters('DataLocale')]",
        "compatibilityLevel": "[parameters('CompatibilityLevel')]",
        "transformation": {
          "name": "Transformation",
          "properties": {
            "streamingUnits": "[parameters('StreamingUnits')]",
            "query": "-- WITH stdev AS\r\n-- (\r\n--     SELECT\r\n--         System.Timestamp() as Timestamp,\r\n--         NodeId,\r\n--         ApplicationUri,\r\n--         IoTHub.ConnectionDeviceId AS ConnectionDeviceId,\r\n--         STDEV(DipData) AS DipStdev\r\n--     FROM iothub TIMESTAMP BY Timestamp\r\n--     WHERE DipData IS NOT NULL\r\n--     GROUP BY NodeId, ApplicationUri, IoTHub.ConnectionDeviceId, TumblingWindow(minute, 3)\r\n-- )\r\n\r\nSELECT\r\n    System.Timestamp() as Timestamp,\r\n    GetMetadataPropertyValue(iothub, 'EventId') AS id,\r\n    NodeId,\r\n    ApplicationUri,\r\n    DipData,\r\n    AVG(DipData) OVER (PARTITION BY iothub.IoTHub.ConnectionDeviceId LIMIT DURATION(minute, 3) WHEN DipData is NOT NULL) AS DipAvg,\r\n    MAX(DipData) OVER (PARTITION BY iothub.IoTHub.ConnectionDeviceId LIMIT DURATION(minute, 3) WHEN DipData is NOT NULL) AS DipMax,\r\n    MIN(DipData) OVER (PARTITION BY iothub.IoTHub.ConnectionDeviceId LIMIT DURATION(minute, 3) WHEN DipData is NOT NULL) AS DipMin,\r\n    COUNT(DipData) OVER (PARTITION BY iothub.IoTHub.ConnectionDeviceId LIMIT DURATION(minute, 3) WHEN DipData is NOT NULL) AS DipCount,\r\n    SpikeData,\r\n    AVG(SpikeData) OVER (PARTITION BY iothub.IoTHub.ConnectionDeviceId LIMIT DURATION(minute, 3) WHEN SpikeData is NOT NULL) AS SpikeAvg,\r\n    MAX(SpikeData) OVER (PARTITION BY iothub.IoTHub.ConnectionDeviceId LIMIT DURATION(minute, 3) WHEN SpikeData is NOT NULL) AS SpikeMax,\r\n    MIN(SpikeData) OVER (PARTITION BY iothub.IoTHub.ConnectionDeviceId LIMIT DURATION(minute, 3) WHEN SpikeData is NOT NULL) AS SpikeMin,\r\n    COUNT(SpikeData) OVER (PARTITION BY iothub.IoTHub.ConnectionDeviceId LIMIT DURATION(minute, 3) WHEN SpikeData is NOT NULL) AS SpikeCount,\r\n    PositiveTrendData,\r\n    AVG(PositiveTrendData) OVER (PARTITION BY iothub.IoTHub.ConnectionDeviceId LIMIT DURATION(minute, 3) WHEN PositiveTrendData is NOT NULL) AS PositiveTrendAvg,\r\n    MAX(PositiveTrendData) OVER (PARTITION BY iothub.IoTHub.ConnectionDeviceId LIMIT DURATION(minute, 3) WHEN PositiveTrendData is NOT NULL) AS PositiveTrendMax,\r\n    MIN(PositiveTrendData) OVER (PARTITION BY iothub.IoTHub.ConnectionDeviceId LIMIT DURATION(minute, 3) WHEN PositiveTrendData is NOT NULL) AS PositiveTrendMin,\r\n    COUNT(PositiveTrendData) OVER (PARTITION BY iothub.IoTHub.ConnectionDeviceId LIMIT DURATION(minute, 3) WHEN PositiveTrendData is NOT NULL) AS PositiveTrendCount,\r\n    NegativeTrendData,\r\n    AVG(NegativeTrendData) OVER (PARTITION BY iothub.IoTHub.ConnectionDeviceId LIMIT DURATION(minute, 3) WHEN NegativeTrendData is NOT NULL) AS NegativeTrendAvg,\r\n    MAX(NegativeTrendData) OVER (PARTITION BY iothub.IoTHub.ConnectionDeviceId LIMIT DURATION(minute, 3) WHEN NegativeTrendData is NOT NULL) AS NegativeTrendMax,\r\n    MIN(NegativeTrendData) OVER (PARTITION BY iothub.IoTHub.ConnectionDeviceId LIMIT DURATION(minute, 3) WHEN NegativeTrendData is NOT NULL) AS NegativeTrendMin,\r\n    COUNT(NegativeTrendData) OVER (PARTITION BY iothub.IoTHub.ConnectionDeviceId LIMIT DURATION(minute, 3) WHEN NegativeTrendData is NOT NULL) AS NegativeTrendCount,\r\n    RandomSignedInt32,\r\n    AVG(RandomSignedInt32) OVER (PARTITION BY iothub.IoTHub.ConnectionDeviceId LIMIT DURATION(minute, 3) WHEN RandomSignedInt32 is NOT NULL) AS RandomSignedAvg,\r\n    MAX(RandomSignedInt32) OVER (PARTITION BY iothub.IoTHub.ConnectionDeviceId LIMIT DURATION(minute, 3) WHEN RandomSignedInt32 is NOT NULL) AS RandomSignedMax,\r\n    MIN(RandomSignedInt32) OVER (PARTITION BY iothub.IoTHub.ConnectionDeviceId LIMIT DURATION(minute, 3) WHEN RandomSignedInt32 is NOT NULL) AS RandomSignedMin,\r\n    COUNT(RandomSignedInt32) OVER (PARTITION BY iothub.IoTHub.ConnectionDeviceId LIMIT DURATION(minute, 3) WHEN RandomSignedInt32 is NOT NULL) AS RandomSignedCount,\r\n    -- Standard deviations\r\n    stdev.DipStdev\r\nINTO cosmosdb\r\nFROM iothub --TIMESTAMP BY Timestamp\r\n-- JOIN StDev TIMESTAMP BY Timestamp\r\n-- ON iothub.IoTHub.ConnectionDeviceId = stdev.ConnectionDeviceId \r\n-- AND iothub.ApplicationUri = stdev.ApplicationUri\r\n-- AND DATEDIFF(minute, iothub, Stdev) BETWEEN 1 AND 3\r\n"
          }
        },
        "inputs": [
          {
            "name": "iothub",
            "properties": {
              "type": "Stream",
              "datasource": {
                "type": "Microsoft.Devices/IotHubs",
                "properties": {
                  "iotHubNamespace": "[parameters('Input_iothub_iotHubNamespace')]",
                  "consumerGroupName": "[parameters('Input_iothub_consumerGroupName')]",
                  "endpoint": "[parameters('Input_iothub_endpoint')]",
                  "sharedAccessPolicyName": "[parameters('Input_iothub_sharedAccessPolicyName')]",
                  "sharedAccessPolicyKey": "[parameters('Input_iothub_sharedAccessPolicyKey')]"
                }
              },
              "compression": {
                "type": "None"
              },
              "serialization": {
                "type": "Json",
                "properties": {
                  "encoding": "UTF8"
                }
              }
            }
          }
        ],
        "outputs": [
          {
            "name": "cosmosdb",
            "properties": {
              "datasource": {
                "type": "Microsoft.Storage/DocumentDB",
                "properties": {
                  "accountId": "[parameters('Output_cosmosdb_accountId')]",
                  "accountKey": "[parameters('Output_cosmosdb_accountKey')]",
                  "database": "[parameters('Output_cosmosdb_database')]",
                  "collectionNamePattern": "[parameters('Output_cosmosdb_collectionNamePattern')]",
                  "partitionKey": null,
                  "documentId": "[parameters('Output_cosmosdb_documentId')]"
                }
              }
            }
          },
          {
            "name": "NotificationsEventHub",
            "properties": {
              "serialization": {
                "type": "Json",
                "properties": {
                  "encoding": "UTF8",
                  "format": "LineSeparated"
                }
              },
              "datasource": {
                "type": "Microsoft.ServiceBus/EventHub",
                "properties": {
                  "serviceBusNamespace": "[parameters('Output_NotificationsEventHub_serviceBusNamespace')]",
                  "eventHubName": "[parameters('Output_NotificationsEventHub_eventHubName')]",
                  "partitionKey": "[parameters('Output_NotificationsEventHub_partitionKey')]",
                  "sharedAccessPolicyName": "[parameters('Output_NotificationsEventHub_sharedAccessPolicyName')]",
                  "sharedAccessPolicyKey": "[parameters('Output_NotificationsEventHub_sharedAccessPolicyKey')]"
                }
              }
            }
          }
        ]
      }
    }
  ]
}